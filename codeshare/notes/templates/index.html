<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codeshare</title>
</head>


<body>
    <h1>Hello, {{ uid }}</h1>
    <textarea id="main-input" style="width: 1000px; height: 400px">{{ source }}</textarea>


    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>


    <script>
        url = new URL(window.location.href)
        if (url.pathname != '/') {
            $('#main-input').focus()
            $('#main-input')[0].setSelectionRange($('#main-input')[0].value.length, $('#main-input')[0].value.length)
        }

        $('#main-input').focusin(() => {
            if (url.pathname == '/')
                create()
        })

        $('#main-input').keyup(() => update(url.pathname.split('/'), false))

        $(window).on("beforeunload", () => update(url.pathname.split('/'), true))


        let create = () => {
            fetch('http://127.0.0.1:8000/api/note/create', {
                method: 'POST',
                body: JSON.stringify({
                    "language": "python",
                    "source": $('#main-input')[0].value
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': Cookies.get('csrftoken')
                },
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data)
                    location = location + data.name
                })
                .catch((error) => {
                    console.error('Error:', error)
                })
        }

        let update = (path, onclose) => {
            fetch('http://127.0.0.1:8000/api/note/update', {
                method: 'PUT',
                body: JSON.stringify({
                    "name": path[1],
                    "language": "python",
                    "source": $('#main-input')[0].value,
                    "onclose": onclose
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': Cookies.get('csrftoken')
                },
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data)
                })
                .catch((error) => {
                    console.error('Error:', error)
                })
        }
    </script>
</body>

</html>